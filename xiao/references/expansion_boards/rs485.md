# RS485 Expansion Board for XIAO

## Overview

The RS485 Expansion Board adds RS485 communication capability to XIAO boards. It features a 5V OUT/IN switch for flexible power management, 120Ω termination switch for bus matching, and a compact design for industrial applications. Ideal for industrial automation, building control, sensor networks, and long-distance communication.

## Hardware

### Board Compatibility

| XIAO Board | Compatible | Notes |
|------------|------------|-------|
| ESP32C3 | ✅ | Full support |
| ESP32C5 | ✅ | Full support |
| ESP32C6 | ✅ | Full support |
| ESP32S3 | ✅ | Full support |
| nRF52840 | ✅ | Full support |
| RP2040 | ✅ | Full support |
| RP2350 | ✅ | Full support |
| SAMD21 | ✅ | Full support |
| RA4M1 | ✅ | Full support |
| MG24 | ✅ | Full support |
| nRF54L15 | ✅ | Full support |

### Features

- **5V OUT/IN Switch**: Flexible power input/output control
- **120Ω Termination Switch**: Enable termination resistor for bus matching
- **INT Port**: Reserved interrupt pin for advanced applications
- **UART Interface**: Simple serial communication
- **Half-Duplex**: Single pair communication (A/B lines)

### Specifications

| Item | Value |
|------|-------|
| Communication Interface | RS485 (half-duplex) |
| UART Pins | D4 (RX), D5 (TX), D2 (Enable) |
| Enable Pin | D2 (TX high = transmit, low = receive) |
| Termination | 120Ω (switchable) |
| Power Switch | 5V OUT/IN |
| Operating Voltage | 5V (external) or 3.3V (XIAO) |

### Pin Connections

| Function | XIAO Pin | Notes |
|----------|-----------|-------|
| RX | D4 (GPIO6 on ESP32C3) | Receive data |
| TX | D5 (GPIO7 on ESP32C3) | Transmit data |
| Enable | D2 | Control TX/RX mode |
| A | RS485 A line | Differential signal + |
| B | RS485 B line | Differential signal - |
| GND | GND | Ground |

**Pin Mapping for ESP32C3:**
```
RX = D4 (GPIO6)
TX = D5 (GPIO7)
Enable = D2
```

**Important:** These pins (D2, D4, D5) are used by the RS485 interface and not available for other uses.

### Board Features

#### 5V OUT/IN Switch

- **IN Mode**: 5V input to power the board from external source
- **OUT Mode**: 5V output to power external sensors/devices

**Warning:** Set switch correctly to prevent damage:
- Use **IN** when board receives external 5V
- Use **OUT** when board supplies 5V to external devices

#### 120Ω Termination Switch

RS485 buses require termination resistors at both ends:
- **OFF**: No termination (middle of bus)
- **ON**: 120Ω enabled (end of bus)

**When to enable:**
- At the beginning of the bus (first device)
- At the end of the bus (last device)
- NOT for devices in the middle

#### INT Port

Reserved interrupt pin for advanced applications (future use).

### Board Layout

```
+------------------------------------------+
|  [5V OUT/IN Switch]                     |
|  [120R Switch]                           |
|                                          |
|  [XIAO Socket]                           |
|                                          |
|  [INT Port]                              |
|                                          |
|  [A]  [B]  [GND]                         |
+------------------------------------------+
```

## Platform Implementations

For platform-specific code examples and library information, see:

- **Arduino**: `/xiao-arduino/references/expansion-boards/rs485.md`
  - HardwareSerial configuration
  - Master/slave communication
  - Multi-drop network examples

- **MicroPython**: Coming soon to `/xiao-micropython/references/expansion-boards/`

## RS485 Communication Basics

### What is RS485?

RS485 is a standard defining the electrical characteristics of drivers and receivers in balanced digital multipoint systems. It supports high-speed data transmission over long distances with noise immunity.

### Key Features

- **Differential Signaling**: A/B lines for noise immunity
- **Multi-Drop**: Up to 32 devices on single bus
- **Long Distance**: Up to 1200m at lower baud rates
- **Half-Duplex**: Single twisted pair for bidirectional
- **High Speed**: Up to 10 Mbps (short distance) or 100 Kbps (1200m)

### Network Topology

```
   [Master]         [Slave 1]         [Slave 2]
      │                 │                 │
      └────A────B───────┴────A────B───────┘
         │                         │
        120Ω                      120Ω
       (term)                    (term)
```

### Communication Modes

**Master-Slave:**
- Master initiates all communication
- Slaves respond only when addressed
- Enable pin controls direction

**Peer-to-Peer:**
- Any device can initiate
- Requires protocol for collision avoidance

## Usage Notes

1. **Enable Pin Control:**
   - Set HIGH before transmitting
   - Set LOW before receiving
   - Add delay after changing state

2. **Baud Rate:** Must match on all devices
   - Common rates: 9600, 19200, 38400, 57600, 115200

3. **Termination:**
   - Enable 120Ω at both ends of bus
   - Disable for middle devices

4. **Power Switch:**
   - Use IN for receiving power
   - Use OUT for powering sensors
   - Never both simultaneously

5. **Maximum Distance:**
   - 100 Kbps: Up to 1200m
   - 9600 baud: Up to 1000m
   - 115200 baud: Up to 100m

## Applications

- **Industrial Automation**: PLC communication, sensor networks
- **Building Control**: HVAC, lighting, access control
- **Sensor Networks**: Temperature, humidity monitoring
- **Point-of-Sale**: Cash register communication
- **Motor Control**: VFD communication

## Troubleshooting

### No Communication

**Symptom**: Cannot send or receive data

**Possible Causes:**
1. Enable pin not set correctly - Check D2 state
2. Wrong baud rate - Match all devices
3. TX/RX reversed - Check A/B connections
4. Missing termination - Enable 120Ω at ends

**Solution**: Verify enable pin logic, check wiring, enable termination

### Garbled Data

**Symptom**: Wrong characters received

**Possible Causes:**
1. Baud rate mismatch - All devices must match
2. Ground loops - Common ground required
3. Cable too long - Reduce distance or lower baud rate
4. Electrical noise - Use shielded twisted pair

**Solution**: Match baud rate, verify ground, use better cable

### One-Way Communication Only

**Symptom**: Can send but not receive (or vice versa)

**Possible Causes:**
1. Enable pin stuck - Verify D2 control
2. Half-duplex timing - Add delay after enable
3. Wrong mode - Master vs slave configuration

**Solution**: Check enable pin timing, verify master/slave roles

### Power Issues

**Symptom**: Board not powering external sensors

**Possible Causes:**
1. Switch in IN position - Should be OUT
2. Overcurrent - Sensor draws too much current
3. Wrong voltage - Check 5V requirement

**Solution**: Set switch to OUT, verify current requirements

## Comparison with CAN Bus

| Feature | RS485 | CAN Bus |
|---------|-------|---------|
| Protocol | Raw serial | Standardized |
| Complexity | Simple | Complex |
| Error Handling | Application-level | Built-in |
| Arbitration | Master/slave | Automatic |
| Cost | Lower | Higher |
| Automotive | Less common | Standard |
| Industrial | Very common | Common |
| Max Devices | 32 | Many |
| Max Speed | 10 Mbps | 1 Mbps |
| Distance | 1200m | Depends on rate |

**Choose RS485 if:** Simple point-to-point, cost-sensitive, industrial networks
**Choose CAN Bus if:** Automotive, robust error handling needed, standardized protocol

## Wiring Example

### Two XIAO with RS485 Boards

```
[XIAO Master]         [XIAO Slave]
    │                     │
    │   D2 → Enable       │
    │   D4 → RX           │
    │   D5 → TX           │
    │                     │
[RS485 Board]         [RS485 Board]
    │                     │
    └────A────B───────────┘
         │
        120Ω (at one end only)
```

**Connection Steps:**
1. Connect A to A on both boards
2. Connect B to B on both boards
3. Connect GND to GND (common ground)
4. Enable 120Ω termination on ONE board only

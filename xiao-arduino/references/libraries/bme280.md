# Adafruit BME280 Library for XIAO

## Overview

BME280 is a combined temperature, humidity, and pressure sensor with I2C interface. High precision and low power consumption.

## Board Compatibility

All XIAO boards with I2C support:
- ESP32C3/C5/C6/S3: I2C on D4/D5
- nRF52840/MG24: I2C on D4/D5
- RP2040/RP2350: I2C on D4/D5
- SAMD21/RA4M1: I2C on D4/D5

## Pin Connection

```cpp
BME280        XIAO Board
------        -----------
VCC    →      3.3V
GND    →      GND
SCL    →      D5 (I2C SCL)
SDA    →      D4 (I2C SDA)

Optional:
CSB    →      3.3V (I2C mode)
SDO    →      GND (I2C address 0x76)
             or 3.3V (I2C address 0x77)
```

## Basic Reading

```cpp
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>

Adafruit_BME280 bme;  // I2C

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76)) {  // Try 0x77 if this fails
        Serial.println("BME280 not found!");
        while (1);
    }

    Serial.println("BME280 initialized");
}

void loop() {
    Serial.print("Temperature = ");
    Serial.print(bme.readTemperature());
    Serial.println(" °C");

    Serial.print("Pressure = ");
    Serial.print(bme.readPressure() / 100.0F);
    Serial.println(" hPa");

    Serial.print("Humidity = ");
    Serial.print(bme.readHumidity());
    Serial.println(" %");

    Serial.println();
    delay(2000);
}
```

## I2C Address Detection

```cpp
#include <Wire.h>

void scanI2C() {
    Serial.println("Scanning I2C bus...");

    for (uint8_t addr = 0x76; addr <= 0x77; addr++) {
        Wire.beginTransmission(addr);
        if (Wire.endTransmission() == 0) {
            Serial.printf("BME280 found at 0x%02X\n", addr);
        }
    }
}

void setup() {
    Serial.begin(115200);
    Wire.begin();
    scanI2C();
}

void loop() {}
```

## Altitude Calculation

```cpp
#include <Adafruit_BME280.h>

Adafruit_BME280 bme;

float SEALEVEL_PRESSURE_HPA = 1013.25;

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76)) {
        while (1);
    }
}

void loop() {
    float temperature = bme.readTemperature();
    float pressure = bme.readPressure() / 100.0F;
    float humidity = bme.readHumidity();
    float altitude = bme.readAltitude(SEALEVEL_PRESSURE_HPA);

    Serial.printf("Temperature: %.2f°C\n", temperature);
    Serial.printf("Pressure: %.2f hPa\n", pressure);
    Serial.printf("Humidity: %.2f%%\n", humidity);
    Serial.printf("Altitude: %.2f meters\n", altitude);

    delay(2000);
}
```

## Weather Station

```cpp
#include <Adafruit_BME280.h>

Adafruit_BME280 bme;

struct WeatherData {
    float temperature;
    float humidity;
    float pressure;
    float dewPoint;
    float altitude;
};

float calculateDewPoint(float temp, float humidity) {
    float a = 17.27;
    float b = 237.7;
    float alpha = ((a * temp) / (b + temp)) + log(humidity / 100.0);
    return (b * alpha) / (a - alpha);
}

WeatherData readWeather() {
    WeatherData data;

    data.temperature = bme.readTemperature();
    data.humidity = bme.readHumidity();
    data.pressure = bme.readPressure() / 100.0F;
    data.altitude = bme.readAltitude(1013.25);
    data.dewPoint = calculateDewPoint(data.temperature, data.humidity);

    return data;
}

void printWeather(WeatherData data) {
    Serial.println("=== Weather Station ===");
    Serial.printf("Temperature: %.1f°C\n", data.temperature);
    Serial.printf("Humidity: %.1f%%\n", data.humidity);
    Serial.printf("Pressure: %.1f hPa\n", data.pressure);
    Serial.printf("Dew Point: %.1f°C\n", data.dewPoint);
    Serial.printf("Altitude: %.1f m\n", data.altitude);
    Serial.println();
}

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76)) {
        Serial.println("BME280 not found!");
        while (1);
    }

    // Configure sensor for weather monitoring
    bme.setSampling(Adafruit_BME280::MODE_NORMAL,
                    Adafruit_BME280::SAMPLING_X16,  // Temperature
                    Adafruit_BME280::SAMPLING_X16,  // Pressure
                    Adafruit_BME280::SAMPLING_X16,  // Humidity
                    Adafruit_BME280::FILTER_X16,
                    Adafruit_BME280::STANDBY_MS_500);
}

void loop() {
    WeatherData data = readWeather();
    printWeather(data);
    delay(5000);
}
```

## Sensor Configuration

```cpp
#include <Adafruit_BME280.h>

Adafruit_BME280 bme;

void configureForWeather() {
    // Normal mode, weather monitoring
    bme.setSampling(Adafruit_BME280::MODE_NORMAL,
                    Adafruit_BME280::SAMPLING_X2,   // Temp oversampling
                    Adafruit_BME280::SAMPLING_X16,  // Pressure oversampling
                    Adafruit_BME280::SAMPLING_X1,   // Humidity oversampling
                    Adafruit_BME280::FILTER_OFF,    // Filtering
                    Adafruit_BME280::STANDBY_MS_1000);
}

void configureForIndoor() {
    // Indoor navigation
    bme.setSampling(Adafruit_BME280::MODE_NORMAL,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::FILTER_X16,
                    Adafruit_BME280::STANDBY_MS_0_5);
}

void configureForLowPower() {
    // Forced mode, lowest power
    bme.setSampling(Adafruit_BME280::MODE_FORCED,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::FILTER_OFF);
}

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76)) {
        while (1);
    }

    // Choose configuration
    configureForWeather();
    // configureForIndoor();
    // configureForLowPower();
}

void loop() {
    delay(2000);
    Serial.printf("Temp: %.2f°C\n", bme.readTemperature());
}
```

## Forced Mode (Low Power)

```cpp
#include <Adafruit_BME280.h>

Adafruit_BME280 bme;

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76)) {
        while (1);
    }

    // Configure for lowest power
    bme.setSampling(Adafruit_BME280::MODE_FORCED,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::SAMPLING_X1,
                    Adafruit_BME280::FILTER_OFF);
}

void loop() {
    // Take one measurement
    bme.takeForcedMeasurement();

    float t = bme.readTemperature();
    float p = bme.readPressure() / 100.0F;
    float h = bme.readHumidity();

    Serial.printf("%.1f°C, %.1f hPa, %.1f%%\n", t, p, h);

    delay(10000);  // Sleep between measurements
}
```

## Data Logging

```cpp
#include <Adafruit_BME280.h>
#include <LittleFS.h>

Adafruit_BME280 bme;

void logData() {
    File file = LittleFS.open("/weather.csv", "a");
    if (!file) {
        return;
    }

    float t = bme.readTemperature();
    float p = bme.readPressure() / 100.0F;
    float h = bme.readHumidity();

    file.printf("%lu,%.2f,%.2f,%.1f\n", millis(), t, p, h);
    file.close();

    Serial.printf("Logged: %.1f°C, %.1f hPa, %.1f%%\n", t, p, h);
}

void setup() {
    Serial.begin(115200);
    LittleFS.begin();

    if (!bme.begin(0x76)) {
        while (1);
    }

    // Create CSV header
    File file = LittleFS.open("/weather.csv", "w");
    file.println("timestamp,temperature,pressure,humidity");
    file.close();
}

void loop() {
    delay(5000);
    logData();
}
```

## OLED Display

```cpp
#include <Adafruit_BME280.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

Adafruit_BME280 bme;
Adafruit_SSD1306 display(128, 64, &Wire, -1);

void setup() {
    Serial.begin(115200);

    if (!bme.begin(0x76) || !display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        while (1);
    }

    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
}

void loop() {
    display.clearDisplay();
    display.setCursor(0, 0);

    display.println("BME280");
    display.println();

    display.printf("%.1f C\n", bme.readTemperature());
    display.printf("%.1f%%\n", bme.readHumidity());
    display.printf("%.1f hPa\n", bme.readPressure() / 100.0F);

    display.display();
    delay(2000);
}
```

## Multiple Sensors

```cpp
#include <Adafruit_BME280.h>
#include <Wire.h>

Adafruit_BME280 bme1;  // Address 0x76
Adafruit_BME280 bme2;  // Address 0x77

void setup() {
    Serial.begin(115200);
    Wire.begin();

    if (!bme1.begin(0x76)) {
        Serial.println("BME280 #1 not found");
    }

    if (!bme2.begin(0x77)) {
        Serial.println("BME280 #2 not found");
    }
}

void loop() {
    Serial.println("Sensor 1:");
    Serial.printf("  %.1f°C, %.1f%%\n", bme1.readTemperature(), bme1.readHumidity());

    Serial.println("Sensor 2:");
    Serial.printf("  %.1f°C, %.1f%%\n", bme2.readTemperature(), bme2.readHumidity());

    delay(2000);
}
```

## Best Practices

```cpp
#include <Adafruit_BME280.h>

void setup() {
    Serial.begin(115200);

    // Best practice 1: Check initialization
    if (!bme.begin(0x76)) {
        if (!bme.begin(0x77)) {
            Serial.println("BME280 not found at either address");
            while(1);
        }
    }

    // Best practice 2: Configure for application
    bme.setSampling(Adafruit_BME280::MODE_NORMAL,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::SAMPLING_X16,
                    Adafruit_BME280::FILTER_X16,
                    Adafruit_BME280::STANDBY_MS_500);
}

// Best practice 3: Validate readings
bool validReading(float value, float min, float max) {
    return !isnan(value) && value >= min && value <= max;
}

void safeRead() {
    float t = bme.readTemperature();
    float h = bme.readHumidity();
    float p = bme.readPressure();

    if (!validReading(t, -40, 85) ||
        !validReading(h, 0, 100) ||
        !validReading(p, 30000, 110000)) {
        Serial.println("Invalid reading");
        return;
    }

    Serial.printf("Valid: %.1f°C, %.1f%%\n", t, h);
}

// Best practice 4: Use forced mode for battery
void lowPowerRead() {
    bme.takeForcedMeasurement();
    float t = bme.readTemperature();
    // Process...
}

void loop() {
    delay(2000);
    safeRead();
}
```

## References

- [Adafruit BME280 Library](https://github.com/adafruit/Adafruit_BME280_Library)
- [BME280 Datasheet](https://www.bosch-sensortec.com/media/boschsensortec/downloads/datasheets/bst-bme280-ds002.pdf)

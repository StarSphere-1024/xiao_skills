# Adafruit ST7789 Library for XIAO

## Overview

ST7789 is a TFT LCD controller supporting 240x320, 135x240 (round), and other resolutions. Used in XIAO round display.

## Board Compatibility

All XIAO boards with SPI:
- ESP32C3/C5/C6/S3: SPI
- nRF52840/MG24: SPI
- RP2040/RP2350: SPI
- SAMD21/RA4M1: SPI

## Pin Connection (SPI)

```cpp
ST7789        XIAO Board
-------       -----------
VCC    →      3.3V
GND    →      GND
SCL    →      D8 (SPI SCK)
SDA    →      D10 (SPI MOSI)
CS     →      D7 (Chip Select)
DC     →      D6 (Data/Command)
RES    →      D5 (Reset) or -1 (shared with MCU reset)
BLK    →      3.3V (Backlight)
```

## XIAO Round Display

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <SPI.h>

// XIAO round display (135x240)
#define TFT_CS D7
#define TFT_DC D6
#define TFT_RST D5

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, TFT_CS, TFT_DC, TFT_RST);

void setup() {
    Serial.begin(115200);

    // Initialize display
    display.init(135, 240);  // XIAO round display size
    display.setRotation(3);  // Landscape orientation

    // Fill screen
    display.fillScreen(ST77XX_BLACK);

    // Draw text
    display.setTextColor(ST77XX_WHITE);
    display.setTextSize(2);
    display.setCursor(20, 50);
    display.println("XIAO");
    display.setCursor(20, 80);
    display.println("Round");
    display.setCursor(20, 110);
    display.println("Display");
}

void loop() {}
```

## Basic Graphics

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

void drawShapes() {
    display.fillScreen(ST77XX_BLACK);

    // Rectangle
    display.drawRect(10, 10, 50, 40, ST77XX_RED);

    // Filled rectangle
    display.fillRect(70, 10, 50, 40, ST77XX_GREEN);

    // Circle (clipped to round display area)
    display.fillCircle(67, 120, 30, ST77XX_BLUE);

    // Triangle
    display.drawTriangle(134, 180, 154, 220, 114, 220, ST77XX_YELLOW);

    // Lines
    display.drawLine(0, 0, 134, 240, ST77XX_WHITE);
    display.drawLine(134, 0, 0, 240, ST77XX_MAGENTA);
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    drawShapes();
}

void loop() {}
```

## Color Display

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

void showColors() {
    display.fillScreen(ST77XX_BLACK);

    // Predefined colors
    display.fillRect(0, 0, 45, 40, ST77XX_RED);
    display.fillRect(45, 0, 45, 40, ST77XX_GREEN);
    display.fillRect(90, 0, 45, 40, ST77XX_BLUE);

    // Custom RGB565 colors
    uint16_t purple = display.color565(128, 0, 128);
    uint16_t orange = display.color565(255, 165, 0);
    uint16_t cyan = display.color565(0, 255, 255);

    display.fillRect(0, 50, 45, 40, purple);
    display.fillRect(45, 50, 45, 40, orange);
    display.fillRect(90, 50, 45, 40, cyan);

    // Gradients (manual)
    for (int i = 0; i < 135; i++) {
        uint8_t r = (i * 255) / 135;
        uint16_t color = display.color565(r, 0, 255 - r);
        display.drawFastVLine(i, 100, 40, color);
    }
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    showColors();
}

void loop() {}
```

## Text with Background

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

void setup() {
    display.init(135, 240);
    display.setRotation(3);

    display.fillScreen(ST77XX_BLACK);

    // White text on black
    display.setTextColor(ST77XX_WHITE);
    display.setTextSize(2);
    display.setCursor(10, 20);
    display.println("White Text");

    // Black text on white
    display.setTextColor(ST77XX_BLACK, ST77XX_WHITE);
    display.setCursor(10, 60);
    display.println("Inverted");

    // Custom color with background
    display.setTextColor(ST77XX_YELLOW, ST77XX_BLUE);
    display.setCursor(10, 100);
    display.println("Yellow on");
    display.println("Blue");

    // Text without background (transparent)
    display.setTextColor(ST77XX_GREEN);  // No background specified
    display.setCursor(10, 160);
    display.println("Transparent");
}

void loop() {}
```

## Round Display Masking

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

// Center of round display
const int CX = 67;
const int CY = 120;
const int RADIUS = 67;

bool inRoundArea(int x, int y) {
    int dx = x - CX;
    int dy = y - CY;
    return (dx * dx + dy * dy) <= (RADIUS * RADIUS);
}

void drawRoundClipped() {
    display.fillScreen(ST77XX_BLACK);

    // Draw circle only in visible area
    for (int y = 0; y < 240; y++) {
        for (int x = 0; x < 135; x++) {
            if (inRoundArea(x, y)) {
                // Calculate pattern
                if ((x + y) % 20 < 10) {
                    display.drawPixel(x, y, ST77XX_BLUE);
                } else {
                    display.drawPixel(x, y, ST77XX_RED);
                }
            }
        }
    }
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    drawRoundClipped();
}

void loop() {}
```

## Gauge/Meter

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

const int CX = 67;
const int CY = 120;
const int RADIUS = 60;

void drawGauge(int percent) {
    display.fillScreen(ST77XX_BLACK);

    // Draw background circle
    display.fillCircle(CX, CY, RADIUS, ST77XX_NAVY);

    // Draw tick marks
    for (int i = 0; i < 360; i += 30) {
        float angle = radians(i);
        int x1 = CX + (RADIUS - 5) * cos(angle);
        int y1 = CY + (RADIUS - 5) * sin(angle);
        int x2 = CX + (RADIUS - 10) * cos(angle);
        int y2 = CY + (RADIUS - 10) * sin(angle);
        display.drawLine(x1, y1, x2, y2, ST77XX_WHITE);
    }

    // Draw needle
    float needleAngle = radians(270 + (percent * 1.8));  // 0% = left, 100% = right
    int needleX = CX + (RADIUS - 15) * cos(needleAngle);
    int needleY = CY + (RADIUS - 15) * sin(needleAngle);
    display.drawLine(CX, CY, needleX, needleY, ST77XX_RED);

    // Center dot
    display.fillCircle(CX, CY, 5, ST77XX_RED);

    // Value text
    display.setTextColor(ST77XX_WHITE);
    display.setTextSize(2);
    display.setCursor(CX - 20, CY + 20);
    display.printf("%d%%", percent);
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
}

void loop() {
    for (int i = 0; i <= 100; i++) {
        drawGauge(i);
        delay(50);
    }
}
```

## Image Display

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

// 16x16 bitmap (RGB565)
const uint16_t logo[] PROGMEM = {
    0xFFFF, 0xFFFF, 0xF800, 0xF800, 0xF800, 0xF800, 0xFFFF, 0xFFFF,
    0xFFFF, 0xFFFF, 0xF800, 0xF800, 0xF800, 0xF800, 0xFFFF, 0xFFFF,
    0xF800, 0xF800, 0xF800, 0xFFFF, 0xFFFF, 0xFFFF, 0xF800, 0xF800,
    0xF800, 0xF800, 0xFFFF, 0xFFFF, 0xFFFF, 0xF800, 0xF800, 0xF800,
};

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    display.fillScreen(ST77XX_BLACK);

    // Draw 16x16 bitmap at 10, 10
    display.drawRGBBitmap(10, 10, logo, 16, 16);
}

void loop() {}
```

## Touch Input (Optional)

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

void checkTouch(int x, int y) {
    // Simple button detection
    if (x > 50 && x < 84 && y > 100 && y < 140) {
        // Center button pressed
        display.fillCircle(CX, CY, 20, ST77XX_GREEN);
        delay(200);
        display.fillCircle(CX, CY, 20, ST77XX_BLUE);
    }
}

void drawButton(int x, int y, int w, int h, const char* label) {
    display.fillRoundRect(x, y, w, h, 10, ST77XX_BLUE);
    display.setTextColor(ST77XX_WHITE);
    display.setTextSize(1);
    display.setCursor(x + w/2 - 10, y + h/2 - 5);
    display.println(label);
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    display.fillScreen(ST77XX_BLACK);

    // Draw button
    drawButton(50, 100, 34, 40, "OK");
}

void loop() {
    // Read touch input (if touch panel available)
    // checkTouch(touchX, touchY);
}
```

## Animation

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

Adafruit_ST7789 display = Adafruit_ST7789(&SPI, D7, D6, D5);

int ballX = 67;
int ballY = 120;
int velX = 2;
int velY = 1;

void animate() {
    // Clear previous ball position
    display.fillCircle(ballX, ballY, 5, ST77XX_BLACK);

    // Update position
    ballX += velX;
    ballY += velY;

    // Bounce off circular boundary
    int dx = ballX - 67;
    int dy = ballY - 120;
    if (dx * dx + dy * dy > 60 * 60) {
        velX = -velX;
        velY = -velY;
    }

    // Draw new ball position
    display.fillCircle(ballX, ballY, 5, ST77XX_RED);

    delay(30);
}

void setup() {
    display.init(135, 240);
    display.setRotation(3);
    display.fillScreen(ST77XX_BLACK);
}

void loop() {
    animate();
}
```

## Best Practices

```cpp
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>

void setup() {
    // Best practice 1: Set rotation early
    display.init(135, 240);
    display.setRotation(3);  // 0-3, depending on orientation

    // Best practice 2: Use appropriate colors
    display.fillScreen(ST77XX_BLACK);  // Clear screen

    // Best practice 3: Batch drawing operations
    display.fillRect(0, 0, 50, 50, ST77XX_RED);
    display.fillRect(50, 0, 50, 50, ST77XX_GREEN);
    // Only push once

    // Best practice 4: Account for round display area
    // Draw important content within central ~120px diameter
    display.setCursor(20, 100);  // Centered text
    display.println("Centered");

    // Best practice 5: Use SPI for faster updates
    // ST7789 supports up to ~62MHz SPI clock
}

void loop() {}
```

## References

- [Adafruit ST7789 Library](https://github.com/adafruit/Adafruit-ST7789-Library)
- [ST7789 Datasheet](https://www.rhydolabz.com/documents/wheels/S7789TFT.pdf)
- [XIAO Round Display Wiki](https://wiki.seeedstudio.com/XIAO-Round-Display-for-XIAO-ESP32S3/)

# Arduino on XIAO MG24

## Overview

The SeeedStudio XIAO MG24 features the Silicon Labs EFR32MG24 series - a multi-protocol wireless SoC supporting Matter, Zigbee, and Bluetooth.

## Board Manager Setup

1. Open Arduino IDE
2. File > Preferences > Additional Boards Manager URLs
3. Add: `https://raw.githubusercontent.com/Seeed-Studio/Seeed_Silicon_Labs_Boards/main/package_Seeed_Silicon_index.json`
4. Tools > Board > Boards Manager > Search "Seeed Silicon" > Install
5. Tools > Board > Seeed Silicon Labs Boards > Select "XIAO MG24"

## First Sketch

```cpp
void setup() {
    Serial.begin(115200);
    pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
    Serial.println("Hello XIAO MG24!");
    digitalWrite(LED_BUILTIN, HIGH);
    delay(1000);
    digitalWrite(LED_BUILTIN, LOW);
    delay(1000);
}
```

## Pin Mapping

| Name | GPIO | Functions | Notes |
|------|------|-----------|-------|
| D0 | PC00 | GPIO, ADC | - |
| D1 | PC01 | GPIO, ADC | - |
| D2 | PC02 | GPIO, ADC | - |
| D3 | PC03 | GPIO, SPI, ADC | - |
| D4 | PC04 | GPIO, I2C SDA, ADC | Default I2C SDA (XIAO standard) |
| D5 | PC05 | GPIO, I2C SCL, ADC | Default I2C SCL (XIAO standard) |
| D6 | PC06 | GPIO, UART TX, ADC | Default UART TX (XIAO standard) |
| D7 | PC07 | GPIO, UART RX, ADC | Default UART RX (XIAO standard) |
| D8 | PA03 | GPIO, SPI SCK, ADC | Default SPI SCK (XIAO standard) |
| D9 | PA04 | GPIO, SPI MISO, ADC | Default SPI MISO (XIAO standard) |
| D10 | PA05 | GPIO, SPI MOSI, ADC | Default SPI MOSI (XIAO standard) |
| D11 | PA09 | GPIO, UART RX, ADC | SAMD11_TX |
| D12 | PA08 | GPIO, UART TX, ADC | SAMD11_RX |
| D13 | PB02 | GPIO, I2C SCL, ADC | Secondary I2C |
| D14 | PB03 | GPIO, I2C SDA, ADC | Secondary I2C |
| D15 | PB00 | GPIO, SPI MOSI, ADC | Secondary SPI |
| D16 | PB01 | GPIO, SPI MISO, ADC | Secondary SPI |
| D17 | PA00 | GPIO, SPI SCK, ADC | Secondary SPI |
| D18 | PD02 | GPIO, CSn, ADC | SPI CS |
| ADC_BAT | PD04 | ADC | Read the BAT voltage value |
| RF Switch Port Select | PB04 | GPIO | Switch onboard antenna and the UFL antenna |
| RF Switch Power | PB05 | GPIO | RF Power |
| Reset | RESET | Reset | RESET |
| CHARGE_LED | VBUS | LED | CHG-LED_Red |
| USER_LED | PA07 | LED | User Light (LED_BUILTIN) |

User LED: PA07 (`LED_BUILTIN`)

## Special Pins

### ADC
- 12-bit ADC (0-4095)
- Single-ended and differential
- Internal temperature sensor

### USART/UART
- Default UART on D6 (TX), D7 (RX)
- LEUART available for low-power

### I2C
- Default: D4 (SDA), D5 (SCL)
- Supports Fast Mode Plus (1 MHz)

### SPI
- Default: D8 (SCK), D9 (MISO), D10 (MOSI)
- CS can be any available GPIO (commonly D3)

## Bluetooth LE

### BLE Peripheral

```cpp
#include <ArduinoBLE.h>

BLEService myService("19B10000-E8F2-537E-4F6C-D104768A1214");
BLEByteCharacteristic myChar("19B10001-E8F2-537E-4F6C-D104768A1214",
                              BLERead | BLEWrite);

void setup() {
    Serial.begin(115200);

    if (!BLE.begin()) {
        Serial.println("BLE init failed");
        while (1);
    }

    BLE.setLocalName("XIAO-MG24");
    BLE.setAdvertisedService(myService);
    myService.addCharacteristic(myChar);
    BLE.addService(myService);
    myChar.writeValue(0);
    BLE.advertise();
}

void loop() {
    BLEDevice central = BLE.central();
    if (central) {
        while (central.connected()) {
            if (myChar.written()) {
                byte value = myChar.value();
                Serial.printf("Received: %d\n", value);
            }
        }
    }
}
```

## Zigbee (Matter)

### Basic Zigbee Device

```cpp
#include <zigbee_handler.h>

void setup() {
    Serial.begin(115200);

    // Initialize Zigbee stack
    zigbee_init();
}

void loop() {
    // Handle Zigbee events
    zigbee_tick();
    delay(10);
}
```

### Matter Support

Note: Full Matter support requires additional SDK and is beyond basic Arduino scope.

## Dynamic Multiprotocol (DMP)

### BLE + Zigbee

```cpp
// MG24 can run BLE and Zigbee simultaneously
// DMP allows dynamic protocol switching

void setup() {
    // Initialize both stacks
    BLE.begin();
    zigbee_init();
}

void loop() {
    BLE.poll();
    zigbee_tick();
}
```

## Low Power

### EM2 (Energy Mode 2)

```cpp
void setup() {
    Serial.begin(115200);

    // Configure for EM2 sleep
    SLEEP_Init_t sleepConfig;
    sleepConfig.mode = sleepEM2;
    SLEEP_Sleep();
}

void loop() {
    // Enter EM2 sleep
    __WFI();
}
```

### EM3 (Deep Sleep)

```cpp
void enterEM3() {
    // Disable all peripherals
    USART0->CMD = USART_CMD_RXDIS | USART_CMD_TXDIS;

    // Enter EM3
    SLEEP_Init(NULL);
    SLEEP_Sleep();
}

void setup() {
    Serial.begin(115200);
    Serial.println("Going to EM3...");
    delay(100);
    enterEM3();
}

void loop() {}
```

### RTCC Wakeup

```cpp
#include <mbedtls/timing.h>

void setup() {
    // Configure RTCC for periodic wake
    RTCC->CC[0].CTRL = RTCC_CC_CTRL_MODE_OFF;
    RTCC->CC[0].CTRL = RTCC_CC_CTRL_MODE_COMPARE;
    RTCC->CC[0].COMP = 32;  // Wake every second
    RTCC->IEN |= RTCC_IEN_CC0;
    NVIC_EnableIRQ(RTCC_IRQn);
}

void RTCC_IRQHandler(void) {
    RTCC->IFC = RTCC_IFC_CC0;
    // Wake from EM3
}

void loop() {}
```

## Radio Coexistence

### Concurrent BLE and Zigbee

```cpp
void setup() {
    // Configure radio scheduler
    RAIL_Scheduler_Init();
    RAIL_Scheduler_SetConfig(true);  // Enable protocol switching

    // Initialize both stacks
    BLE.begin();
    zigbee_init();
}

void loop() {
    BLE.poll();
    zigbee_tick();
}
```

## AES Encryption

```cpp
#include <crypto/aes.h>

void encryptData(uint8_t* data, size_t len) {
    uint8_t key[16] = {0x00};  // Your key

    mbedtls_aes_context aes;
    mbedtls_aes_init(&aes);
    mbedtls_aes_setkey_enc(&aes, key, 128);

    uint8_t iv[16] = {0};
    mbedtls_aes_crypt_cbc(&aes, MBEDTLS_AES_ENCRYPT,
                          len, iv, data, data);

    mbedtls_aes_free(&aes);
}
```

## Temperature Sensor

```cpp
void setup() {
    Serial.begin(115200);
}

void loop() {
    // Enable temperature sensor
    EMU->CTRL |= EMU_CTRL_EM32TEMP;
    delay(10);

    // Read temperature
    int32_t temp = EMU->EM4CTRL;
    float tempC = (temp * 0.025) - 14;

    Serial.printf("Temperature: %.2f C\n", tempC);
    delay(1000);
}
```

## Battery Monitoring

```cpp
void setup() {
    Serial.begin(115200);

    // Enable battery monitor
    EMU->BUACT = EMU_BUACT_BUEXTPWR;
    EMU->BUINACT = EMU_BUINACT_BUEXTPWR;
    EMU->BUCTRL = EMU_BUCTRL_BUMODES_BUMODE_BAT | EMU_BUCTRL_BUEN;
}

void loop() {
    // Read battery voltage
    uint32_t batt = EMU->BUVINP;
    float voltage = (batt * 2 * 1.25) / 4095;

    Serial.printf("Battery: %.2f V\n", voltage);
    delay(5000);
}
```

## PA/LNA Control

```cpp
// Configure Power Amplifier and Low Noise Amplifier
void setupRadioPA() {
    // Enable PA (20 dBm output)
    GPIO->P[3].DOUTSET = 1 << 5;  // PA enable

    // Enable LNA
    GPIO->P[3].DOUTSET = 1 << 6;  // LNA enable
}
```

## Key Specifications

| Feature | Value |
|---------|-------|
| MCU | EFR32MG24 |
| Core | ARM Cortex-M33 @ 78MHz |
| Flash | 1024 KB |
| RAM | 256 KB |
| Radio | 2.4 GHz, +20 dBm |
| Protocols | BLE 5.4, Zigbee, Matter |
| GPIO | 15+ pins |
| ADC | 12-bit |
| DAC | 12-bit, 1 channel |
| Security | AES-128/256, ECC |

## Key Differences from nRF52840

| Feature | EFR32MG24 | nRF52840 |
|---------|-----------|----------|
| Core | Cortex-M33 | Cortex-M4 |
| Protocols | BLE + Zigbee + Matter | BLE only |
| Flash | 1024 KB | 1024 KB |
| RAM | 256 KB | 256 KB |
| TX Power | +20 dBm | +8 dBm |
| DMP | Yes | No |

## Known Issues

1. **DMP**: Limited documentation for Arduino
2. **Matter**: Requires Silicon Labs SDK, not in Arduino
3. **Power**: High TX power requires good supply
4. **Heat**: Can get warm at +20 dBm

## Troubleshooting

### Can't upload
- Check bootloader mode
- Install correct board package
- Try power cycling

### BLE won't start
- Check crystal oscillator
- Verify HFXO is enabled
- Check antenna connection

### Zigbee issues
- Ensure PAN ID matches
- Check channel settings
- Verify coordinator is running

### High power consumption
- Check sleep mode settings
- Verify radio is off when not needed
- Disable unused peripherals

## Best Practices

1. **Radio**: Use PA only when needed (consumes more power)
2. **Antenna**: Keep antenna area clear
3. **Power**: Use 3.3V supply with 500mA+ capability
4. **Heat**: Add thermal pad for continuous TX
5. **Coexistence**: Configure scheduler for DMP

## Performance Tips

1. **BLE**: Use long intervals for battery devices
2. **Zigbee**: Use polled mode for lower power
3. **DMP**: Stagger radio activities
4. **Sleep**: Use EM3 for lowest power
5. **AES**: Hardware acceleration is fast
